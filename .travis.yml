language: java
jdk:
  - openjdk15
services:
  - docker
script:
  - ./mvnw -pl telegram-bot clean install -DskipTests -Dlogin=lev -Ddb=srabot -Dhost=46.17.47.80 -Dport=5432 -Dpassword=oU88hY33B75HHnd -P codegen
before_script:
  - "sudo cat /etc/docker/daemon.json | jq '. + {\"insecure-registries\": [\"185.22.152.167:5000\"]}' | sudo tee /etc/docker/daemon.json"
after_success:
  - eval "$(ssh-agent -s)"
  - chmod 600 $TRAVIS_BUILD_DIR/deploy_rsa
  - ssh-add $TRAVIS_BUILD_DIR/deploy_rsa
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD http://185.22.152.167:5000
  - docker build -t 185.22.152.167:5000/bot-image telegram-bot/.
  - docker push 185.22.152.167:5000/bot-image:latest
  - ssh root@185.22.152.167 docker stop tg-bot
  - ssh root@185.22.152.167 docker rm tg-bot
  - ssh root@185.22.152.167 docker pull 185.22.152.167:5000/bot-image
  - ssh root@185.22.152.167 docker run -d --name tg-bot -p 185.22.152.167:5000/bot-image
